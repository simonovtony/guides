# Формат JSON, метод toJSON

В этой главе мы рассмотрим работу с форматом JSON, который используется для представления объектов в виде строки.

Это один из наиболее удобных форматов данных при взаимодействии с JavaScript. Если нужно с сервера взять объект с данными и передать его клиенту, то в качестве промежуточного формата – для передачи по сети, почти всегда используют именно его.

В современных браузерах есть замечательные методы, знание тонкостей которых делает операции с JSON простыми и комфортными.

## Формат JSON

Данные в формате JSON (RFC 4627) представляют собой:

* JavaScript-объекты { ... } или
* Массивы [ ... ] или
* Значения одного из типов:
1. строки в двойных кавычках,
2. число
3. логическое значение true/false
4. null


Почти все языки программирования имеют библиотеки для преобразования объектов в формат JSON.

Основные методы для работы с JSON в JavaScript – это:

* JSON.parse – читает объекты из строки в формате JSON.
* JSON.stringify – превращает объекты в строку в формате JSON, используется, когда нужно из JavaScript передать данные по сети.

## Метод JSON.parse

Вызов JSON.parse(str) превратит строку с данными в формате JSON в JavaScript-объект/массив/значение.

Например:

`example-1.html`

Или так:

`example-2.html`

Данные могут быть сколь угодно сложными, объекты и массивы могут включать в себя другие объекты и массивы. Главное, чтобы они соответствовали формату.

#### JSON-объекты ≠ JavaScript-объекты

Объекты в формате JSON похожи на обычные JavaScript-объекты, но отличаются от них более строгими требованиями к строкам – они должны быть именно в двойных кавычках.

В частности, первые два свойства объекта ниже – некорректны:

    {
        name: "Вася",       // ошибка: ключ name без кавычек!
        "surname": 'Петров',// ошибка: одинарные кавычки у значения 'Петров'!
        "age": 35,           // .. а тут всё в порядке.
        "isAdmin": false    // и тут тоже всё ок
    }

Кроме того, в формате JSON не поддерживаются комментарии. Он предназначен только для передачи данных.

Есть нестандартное расширение формата JSON, которое называется JSON5 и как раз разрешает ключи без кавычек, комментарии и т.п, как в обычном JavaScript. На данном этапе это отдельная библиотека.

## Умный разбор JSON.parse(str, reviver)

Метод JSON.parse поддерживает и более сложные алгоритмы разбора.

Например, мы получили с сервера объект с данными события event.

Он выглядит так:

`example-3.html` 

…И теперь нужно восстановить его, то есть превратить в JavaScript-объект.

Попробуем вызвать для этого JSON.parse:

`example-3.html`


…Увы, ошибка!

Дело в том, что значением event.date является строка, а отнюдь не объект Date. Откуда методу JSON.parse знать, что нужно превратить строку именно в дату?

#### Для интеллектуального восстановления из строки у JSON.parse(str, reviver) есть второй параметр reviver, который является функцией function(key, value).

Если она указана, то в процессе чтения объекта из строки JSON.parse передаёт ей по очереди все создаваемые пары ключ-значение и может возвратить либо преобразованное значение, либо undefined, если его нужно пропустить.

В данном случае мы можем создать правило, что ключ date всегда означает дату:

`example-4.html`

Кстати, эта возможность работает и для вложенных объектов тоже:

`example-5.html`

## Сериализация, метод JSON.stringify

Метод JSON.stringify(value, replacer, space) преобразует («сериализует») значение в JSON-строку.

Пример использования:

`example-6.html`

#### При сериализации объекта вызывается его метод toJSON.

Если такого метода нет – перечисляются его свойства, кроме функций.

Посмотрим это в примере посложнее:

`example-7.html`

Обратим внимание на два момента:

1. Дата превратилась в строку. Это не случайно: у всех дат есть встроенный метод toJSON. Его результат в данном случае – строка в таймзоне UTC.
2. У объекта room нет метода toJSON. Поэтому он сериализуется перечислением свойств.

Мы, конечно, могли бы добавить такой метод, тогда в итог попал бы его результат:

`example-8.html`

## Исключение свойств

Попытаемся преобразовать в JSON объект, содержащий ссылку на DOM.

Например:

`example-9.html`

Произошла ошибка! В чём же дело? Неужели некоторые объекты запрещены? Как видно из текста ошибки – дело совсем в другом. Глобальный объект window – сложная структура с кучей встроенных свойств и круговыми ссылками, поэтому его преобразовать невозможно. Да и нужно ли?

#### Во втором параметре JSON.stringify(value, replacer) можно указать массив свойств, которые подлежат сериализации.

Например:

`example-10.html`

Для более сложных ситуаций вторым параметром можно передать функцию function(key, value), которая возвращает сериализованное value либо undefined, если его не нужно включать в результат:

`example-11.html`

В примере выше функция пропустит свойство с названием window. Для остальных она просто возвращает значение, передавая его стандартному алгоритму. А могла бы и как-то обработать.

#### Функция replacer работает рекурсивно

То есть, если объект содержит вложенные объекты, массивы и т.п., то все они пройдут через replacer.

## Красивое форматирование

В методе JSON.stringify(value, replacer, space) есть ещё третий параметр space.

Если он является числом – то уровни вложенности в JSON оформляются указанным количеством пробелов, если строкой – вставляется эта строка.

Например:

`example-12.html`

## Итого

* JSON – формат для представления объектов (и не только) в виде строки.
* Методы JSON.parse и JSON.stringify позволяют интеллектуально преобразовать объект в строку и обратно.

