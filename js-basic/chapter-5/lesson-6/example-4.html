<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
</head>
<body>
<script>
    /*************************************************
     * Замыкания
     *************************************************/

    /**
     * Объекты переменных, о которых шла речь ранее, в главе про замыкания,
     * также подвержены сборке мусора. Они следуют тем же правилам, что и
     * обычные объекты.
     *
     * Объект переменных внешней функции существует в памяти до тех пор,
     * пока существует хоть одна внутренняя функция, ссылающаяся на него
     * через свойство [[Scope]].
     *
     * Например:
     *
     * 1) Обычно объект переменных удаляется по завершении работы функции.
     *    Даже если в нём есть объявление внутренней функции:
     */
    function f() {
        var value = 123;
        function g() {} // g видна только изнутри
    }
    f();

    /**
     *    В коде выше value и g являются свойствами объекта переменных. Во время
     *    выполнения f() её объект переменных находится в текущем стеке выполнения,
     *    поэтому жив. По окончанию, он станет недостижимым и будет убран из
     *    памяти вместе с остальными локальными переменными.
     *
     * 2) …А вот в этом случае лексическое окружение, включая переменную value,
     *    будет сохранено:
     */
    function f() {
        var value = 123;

        function g() {}

        return g;
    }

    var g = f(); // // функция g будет жить и сохранит ссылку на объект переменных

    /**
     *    В скрытом свойстве g.[[Scope]] находится ссылка на объект переменных,
     *    в котором была создана g. Поэтому этот объект переменных останется в
     *    памяти, а в нём – и value.
     *
     * 3) Если f() будет вызываться много раз, а полученные функции будут
     *    сохраняться, например, складываться в массив, то будут сохраняться
     *    и объекты LexicalEnvironment с соответствующими значениями value:
     */
    function f() {
        var value = Math.random();

        return function() {
            return value;
        }
    }

    // 3) функции, каждая ссылается на свой объект переменных,
    //    каждый со своим значением value
    var arr = [f(), f(), f()];

    /**
     * 4) Объект LexicalEnvironment живёт ровно до тех пор, пока на него существуют
     *    ссылки. В коде ниже после удаления ссылки на g умирает:
     */
    function f() {
        var value = 123;

        function g() { }

        return g;
    }

    var g = f(); // функция g жива
    // а значит в памяти остается соответствующий объект переменных f()
    g = null; // ..а вот теперь память будет очищена
</script>
</body>
</html>